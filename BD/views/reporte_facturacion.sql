DELIMITER $$

ALTER ALGORITHM=UNDEFINED DEFINER=`root`@`localhost` SQL SECURITY DEFINER VIEW `reporte_facturacion` AS 
SELECT `clientes`.`id` AS `cliente_id`,`zr`.`created` AS `FECHA_RADICACION`,`users`.`id` AS `user_id`,`users`.`nombre` AS `USUARIO_ASISTEMYCA`,(SELECT UCASE(`users1`.`nombre`) FROM `users` `users1` WHERE (`users1`.`id` = `gcc`.`GESTION_USUARIO_ID`)) AS `USUARIO_CAPTURA`,`gcc`.`FECHA_GESTION` AS `FECHA_CAPTURA`,`zr`.`numero_planilla` AS `NUMERO_PLANILLA`,IF((`zr`.`fecha_diligenciamiento` = '0000-00-00'),NULL,`zr`.`fecha_diligenciamiento`) AS `FECHA_DILIGENCIAMIENTO`,`zr`.`correo_radicacion` AS `USUARIO_SUSCRIPTOR`,`zr`.`separado` AS `SEPARADO`,`td`.`codigo` AS `TIPO_CLIENTE_CODIGO`,`clientes`.`documento` AS `CLIENTE_DOCUMENTO`,CONCAT_WS('-',CONVERT(CONCAT(DATE_FORMAT(CAST(`zr`.`created` AS DATE),'%Y%m%d'),`zr`.`cliente_id`) USING utf8mb4),`zr`.`consecutivo`) AS `NUMERO_RADICACION`,`zr`.`cantidad_documentos` AS `CANT_DOCUMENTOS`,TRIM(CONCAT_WS(' ',`cn`.`primer_apellido`,`cn`.`segundo_apellido`,`cn`.`primer_nombre`,`cn`.`segundo_nombre`)) AS `NOMBRE_TOMADOR`,IF((`zr`.`repetido` = 1),'SI','NO') AS `FORMULARIO_REPETIDO`,(SELECT MAX(`gccv1`.`FECHA_GESTION`) FROM `gestion_clientes_completitud_verificacion` `gccv1` WHERE ((`gccv1`.`GESTION_CLIENTE_ID` = `gccv`.`GESTION_CLIENTE_ID`) AND (`gccv1`.`GESTION_PROCESO_ID` = 6))) AS `PROCESO_COMPLETITUD`,(SELECT MAX(`gccv2`.`FECHA_GESTION`) FROM `gestion_clientes_completitud_verificacion` `gccv2` WHERE ((`gccv2`.`GESTION_CLIENTE_ID` = `gccv`.`GESTION_CLIENTE_ID`) AND (`gccv2`.`GESTION_PROCESO_ID` = 5))) AS `PROCESO_VERIFICACION`,`zt`.`tipologia` AS `ESTADO_TIPOLOGIA`,`gccv`.`GESTION_NO_INTENTOS` AS `INTENTO_LLAMADA`,`zr`.`tipo_medio` AS `FORMA_RECEPCION`,`zr`.`radicacion_proceso` AS `RADICACION_PROCESO`,`zr`.`formulario` AS `TIPO_FORMULARIO`,`zepcs`.`PROCESO_INOUTBOUND` AS `TIPO_LLAMADA`,IF((`zr`.`repetido` <> 1),IF((`es`.`desc_type` IS NOT NULL),`es`.`desc_type`,'FECHA ANTIGUA'),'DEVUELTO') AS `ESTADO_PROCESO`,IF(((`zepcs`.`ESTADO_PROCESO_ID` NOT IN (2,1)) AND (`zr`.`repetido` <> 1)),`zepcs`.`FECHA_PROCESO`,NULL) AS `FECHA_PROCESO_CAPTURA`,IF(((`zepcs`.`ESTADO_PROCESO_ID` NOT IN (2,1)) AND (`zr`.`repetido` <> 1)),'Si','No') AS `FORMULARIO_CAPTURADO`,`zr`.`radicacion_observacion` AS `OBSERVACION` FROM (((((((((`clientes` JOIN `tipos_documentos` `td` ON((`td`.`id` = `confianza`.`clientes`.`tipo_documento`))) JOIN `zr_radicacion` `zr` ON((`zr`.`cliente_id` = `confianza`.`clientes`.`id`))) JOIN `users` ON((`confianza`.`users`.`id` = `zr`.`funcionario_id`))) JOIN `cliente_sarlaft_natural` `cn` ON((`cn`.`cliente` = `zr`.`cliente_id`))) LEFT JOIN `gestion_clientes_captura` `gcc` ON(((`gcc`.`GESTION_CLIENTE_ID` = `zr`.`cliente_id`) AND (`gcc`.`FECHA_GESTION` = (SELECT MAX(`gcc2`.`FECHA_GESTION`) FROM `gestion_clientes_captura` `gcc2` WHERE ((`gcc2`.`GESTION_CLIENTE_ID` = `gcc`.`GESTION_CLIENTE_ID`) AND (`gcc2`.`GESTION_FECHA_DILIGENCIAMIENTO` = `zr`.`fecha_diligenciamiento`) AND (`gcc2`.`FECHA_GESTION` >= `zr`.`created`))))))) LEFT JOIN `gestion_clientes_completitud_verificacion` `gccv` ON(((`gccv`.`GESTION_CLIENTE_ID` = `zr`.`cliente_id`) AND (`gccv`.`FECHA_GESTION` = (SELECT MAX(`gccv2`.`FECHA_GESTION`) FROM `gestion_clientes_completitud_verificacion` `gccv2` WHERE ((`gccv2`.`GESTION_CLIENTE_ID` = `gccv`.`GESTION_CLIENTE_ID`) AND (`gccv2`.`GESTION_FECHA_DILIGENCIAMIENTO` = `zr`.`fecha_diligenciamiento`) AND (`gccv2`.`FECHA_GESTION` >= `zr`.`created`))))))) LEFT JOIN `zr_tipologias` `zt` ON((`zt`.`id` = `gccv`.`GESTION_ESTADO_TIPOLOGIA_ID`))) LEFT JOIN `zr_estado_proceso_clientes_sarlaft` `zepcs` ON(((`zepcs`.`PROCESO_CLIENTE_ID` = `zr`.`cliente_id`) AND (`zepcs`.`FECHA_PROCESO` = (SELECT MAX(`zepcs1`.`FECHA_PROCESO`) FROM `zr_estado_proceso_clientes_sarlaft` `zepcs1` WHERE ((`zepcs1`.`PROCESO_CLIENTE_ID` = `zepcs`.`PROCESO_CLIENTE_ID`) AND (`zepcs1`.`PROCESO_FECHA_DILIGENCIAMIENTO` = `zr`.`fecha_diligenciamiento`) AND (`zepcs1`.`FECHA_PROCESO` >= `zr`.`created`))))))) LEFT JOIN `estados_sarlaft` `es` ON((`es`.`id` = `zepcs`.`ESTADO_PROCESO_ID`))) UNION ALL SELECT `confianza`.`clientes`.`id` AS `cliente_id`,`zr`.`created` AS `FECHA_RADICACION`,`confianza`.`users`.`id` AS `user_id`,`confianza`.`users`.`nombre` AS `USUARIO_ASISTEMYCA`,(SELECT UCASE(`users1`.`nombre`) FROM `users` `users1` WHERE (`users1`.`id` = `gcc`.`GESTION_USUARIO_ID`)) AS `USUARIO_CAPTURA`,`gcc`.`FECHA_GESTION` AS `FECHA_CAPTURA`,`zr`.`numero_planilla` AS `NUMERO_PLANILLA`,IF((`zr`.`fecha_diligenciamiento` = '0000-00-00'),NULL,`zr`.`fecha_diligenciamiento`) AS `FECHA_DILIGENCIAMIENTO`,`zr`.`correo_radicacion` AS `USUARIO_SUSCRIPTOR`,`zr`.`separado` AS `SEPARADO`,`td`.`codigo` AS `TIPO_CLIENTE_CODIGO`,`confianza`.`clientes`.`documento` AS `CLIENTE_DOCUMENTO`,CONCAT_WS('-',CONCAT(DATE_FORMAT(CAST(`zr`.`created` AS DATE),'%Y%m%d'),`zr`.`cliente_id`),`zr`.`consecutivo`) AS `NUMERO_RADICACION`,`zr`.`cantidad_documentos` AS `CANT_DOCUMENTOS`,TRIM(`cj`.`razon_social`) AS `NOMBRE_TOMADOR`,IF((`zr`.`repetido` = 1),'SI','NO') AS `FORMULARIO_REPETIDO`,(SELECT MAX(`gccv1`.`FECHA_GESTION`) FROM `gestion_clientes_completitud_verificacion` `gccv1` WHERE ((`gccv1`.`GESTION_CLIENTE_ID` = `gccv`.`GESTION_CLIENTE_ID`) AND (`gccv1`.`GESTION_PROCESO_ID` = 6))) AS `PROCESO_COMPLETITUD`,(SELECT MAX(`gccv2`.`FECHA_GESTION`) FROM `gestion_clientes_completitud_verificacion` `gccv2` WHERE ((`gccv2`.`GESTION_CLIENTE_ID` = `gccv`.`GESTION_CLIENTE_ID`) AND (`gccv2`.`GESTION_PROCESO_ID` = 5))) AS `PROCESO_VERIFICACION`,`zt`.`tipologia` AS `ESTADO_TIPOLOGIA`,`gccv`.`GESTION_NO_INTENTOS` AS `INTENTO_LLAMADA`,`zr`.`tipo_medio` AS `FORMA_RECEPCION`,`zr`.`radicacion_proceso` AS `RADICACION_PROCESO`,`zr`.`formulario` AS `TIPO_FORMULARIO`,`zepcs`.`PROCESO_INOUTBOUND` AS `TIPO_LLAMADA`,IF((`zr`.`repetido` <> 1),IF((`es`.`desc_type` IS NOT NULL),`es`.`desc_type`,'FECHA ANTIGUA'),'DEVUELTO') AS `ESTADO_PROCESO`,IF(((`zepcs`.`ESTADO_PROCESO_ID` NOT IN (2,1)) AND (`zr`.`repetido` <> 1)),`zepcs`.`FECHA_PROCESO`,NULL) AS `FECHA_PROCESO_CAPTURA`,IF(((`zepcs`.`ESTADO_PROCESO_ID` NOT IN (2,1)) AND (`zr`.`repetido` <> 1)),'Si','No') AS `FORMULARIO_CAPTURADO`,`zr`.`radicacion_observacion` AS `OBSERVACION` FROM (((((((((`clientes` JOIN `tipos_documentos` `td` ON((`td`.`id` = `confianza`.`clientes`.`tipo_documento`))) JOIN `zr_radicacion` `zr` ON((`zr`.`cliente_id` = `confianza`.`clientes`.`id`))) JOIN `users` ON((`confianza`.`users`.`id` = `zr`.`funcionario_id`))) JOIN `cliente_sarlaft_juridico` `cj` ON((`cj`.`cliente` = `zr`.`cliente_id`))) LEFT JOIN `gestion_clientes_captura` `gcc` ON(((`gcc`.`GESTION_CLIENTE_ID` = `zr`.`cliente_id`) AND (`gcc`.`FECHA_GESTION` = (SELECT MAX(`gcc2`.`FECHA_GESTION`) FROM `gestion_clientes_captura` `gcc2` WHERE ((`gcc2`.`GESTION_CLIENTE_ID` = `gcc`.`GESTION_CLIENTE_ID`) AND (`gcc2`.`GESTION_FECHA_DILIGENCIAMIENTO` = `zr`.`fecha_diligenciamiento`) AND (`gcc2`.`FECHA_GESTION` >= `zr`.`created`))))))) LEFT JOIN `gestion_clientes_completitud_verificacion` `gccv` ON(((`gccv`.`GESTION_CLIENTE_ID` = `zr`.`cliente_id`) AND (`gccv`.`FECHA_GESTION` = (SELECT MAX(`gccv2`.`FECHA_GESTION`) FROM `gestion_clientes_completitud_verificacion` `gccv2` WHERE ((`gccv2`.`GESTION_CLIENTE_ID` = `gccv`.`GESTION_CLIENTE_ID`) AND (`gccv2`.`GESTION_FECHA_DILIGENCIAMIENTO` = `zr`.`fecha_diligenciamiento`) AND (`gccv2`.`FECHA_GESTION` >= `zr`.`created`))))))) LEFT JOIN `zr_tipologias` `zt` ON((`zt`.`id` = `gccv`.`GESTION_ESTADO_TIPOLOGIA_ID`))) LEFT JOIN `zr_estado_proceso_clientes_sarlaft` `zepcs` ON(((`zepcs`.`PROCESO_CLIENTE_ID` = `zr`.`cliente_id`) AND (`zepcs`.`FECHA_PROCESO` = (SELECT MAX(`zepcs1`.`FECHA_PROCESO`) FROM `zr_estado_proceso_clientes_sarlaft` `zepcs1` WHERE ((`zepcs1`.`PROCESO_CLIENTE_ID` = `zepcs`.`PROCESO_CLIENTE_ID`) AND (`zepcs1`.`PROCESO_FECHA_DILIGENCIAMIENTO` = `zr`.`fecha_diligenciamiento`) AND (`zepcs1`.`FECHA_PROCESO` >= `zr`.`created`))))))) LEFT JOIN `estados_sarlaft` `es` ON((`es`.`id` = `zepcs`.`ESTADO_PROCESO_ID`)))$$

DELIMITER ;